= content_for :title, 'Paiement du Programme'
= content_for :hide_header, true
= content_for :hide_footer, true

#payment
  %header
    %div.left
      %span.white-logo
      %a.second{ href: 'javascript:history.back();' }
        ←&nbsp;
        %span.back RETOUR
        %br
        %span.sub Inscription au programme d’orientation Bloomr
    %p.hide-phone Paiement sécurisé par <b>stripe</b>
  %section.main
    %h1.title Fabuleuse décision !

    %p.last-step Dernière étape avant de commencer le programme : l’inscription !
    = form_for Bloomy.new, url: '/payment' do |f|
      = f.text_field :first_name, placeholder: 'Prénom', required: true
      = f.email_field :email, placeholder: 'Adresse email', required: true, 'data-stripe' => 'name'
      = f.text_field :age, placeholder: 'Âge', required: true

      %p#flash-messages

      %p.and Et le paiement :)
      .payment2-cards

      %p
      = text_field_tag nil, nil, placeholder: 'Numéro de carte', required: true, class: 'large-cb cc-number', 'data-stripe' => 'number'
      = text_field_tag nil, nil, placeholder: 'MM/YY', required: true, class: 'small-cb cc-exp', 'data-stripe' => 'exp'
      = text_field_tag nil, nil, placeholder: 'CVC', required: true, class: 'small-cb cc-cvc', 'data-stripe' => 'cvc'

      %p.cgu
        En t'inscrivant au programme, tu acceptes les
        %a{ href: 'https://drive.google.com/file/d/0B6t2xBTfe9gaZzM5VHdrRlZJQm8/view' }conditions générales
        et certifie avoir 14 ans minimum. Remboursement sur simple demande dans un délai de 14 jours.

      = button_tag "Payer #{@price} €", class: 'crazy-btn yellow'
      %p ou bien
      %a.paypal{ href: "https://paypal.me/bloomr/#{@price}" }
        %span Payer avec 
        %span.payment2-paypal Paypal

  %footer
    %a{ href: '/' } Bloomr

= javascript_include_tag 'https://js.stripe.com/v2/'

:javascript
  $(function(){
    Stripe.setPublishableKey("#{ ENV['STRIPE_PUBLISHABLE_KEY'] }");
  });

:javascript
  jQuery(function ($) {
    $('input.cc-number').payment('formatCardNumber');
    $('input.cc-exp').payment('formatCardExpiry');
    $('input.cc-cvc').payment('formatCardCVC');
  })


:javascript
  jQuery(function ($) {
  var show_error, stripeResponseHandler;

  var errorMessages = {
    incorrect_number: "Le numéro de carte est incorrect.",
    invalid_number: "Le numéro de carte n'est pas valide.",
    invalid_expiry_month: "Le mois d'expiration n'est pas valide.",
    invalid_expiry_year: "L'année d'expiration n'est pas valide.",
    invalid_cvc: "Le code de sécurité n'est pas valide.",
    expired_card: "La carte a expiré.",
    incorrect_cvc: "Le code de sécurité de la carte est incorrect.",
    card_declined: "Carte rejetée.",
    processing_error: "Une erreur est survenue.",
    empty_mail: "Veuillez saisir votre adresse mail"
  };

  $("#new_bloomy").submit(function (event) {
    var $form = $(this);

    if($('#email').val() === '') {
      show_error('empty_mail')
      return false;
    }

    $form.find("input[type=submit]").prop("disabled", true);
    Stripe.card.createToken($form, stripeResponseHandler);
    return false;
  });

  stripeResponseHandler = function (status, response) {
    var $form, token;
    $form = $("#new_bloomy");
    if (response.error) {
      show_error(response.error.code);
      $form.find("input[type=submit]").prop("disabled", false);
    } else {
      token = response.id;
      $form.append($("<input type=\"hidden\" name=\"stripeToken\" />").val(token));
      $form.get(0).submit();
    }
    return false;
    };

  show_error = function (code) {
    $("#flash-messages").html('<div class="alert alert-warning"><a class="close" data-dismiss="alert">×</a><div id="flash_alert">' + errorMessages[code] + '</div></div>');
    $('.alert').delay(5000).fadeOut(3000);
    return false;
    };
    });
