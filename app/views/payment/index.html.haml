= content_for :title, 'Paiement du Parcours'

#payment.full-blue
  .center
    =image_tag 'payment/parcours.jpg', class: 'journey-img'

    %h1 Fabuleuse décision !

    %p Dernière étape avant de démarrer l'aventure : <br/>t'inscrire et régler le parcours
    = form_tag '/payment', :id => 'new_payment' do
      = text_field_tag :first_name, nil, placeholder: 'Ton prénom', required: true, class: 'blue'
      = email_field_tag :email, nil, placeholder: 'Ton adresse email', required: true, class: 'blue', 'data-stripe' => 'name'
      = text_field_tag :age, nil, placeholder: 'Ton age', required: true, class: 'blue'

      %div{style: 'position: relative; display: inline-block'}
      %p#flash-messages
      %p
        =image_tag('payment/Visa.png', alt: 'Visa', width: '60')
        =image_tag('payment/MasterCard.png', alt: 'Mastercard', width: '60')
      %p
        %span.glyphicon.glyphicon-lock
        Informations de paiement
      = text_field_tag nil, nil, placeholder: 'Numéro de carte', required: true, class: 'large-cb cc-number', 'data-stripe' => 'number'
      %div.form-inline
        = text_field_tag nil, nil, placeholder: 'MM/YY', required: true, class: 'small-cb cc-exp', 'data-stripe' => 'exp'
        = text_field_tag nil, nil, placeholder: 'CVC', required: true, class: 'small-cb cc-cvc', 'data-stripe' => 'cvc'

      %p.legal En t'inscrivant au parcours, tu acceptes les <a href= 'https://drive.google.com/file/d/0B6t2xBTfe9gaZzM5VHdrRlZJQm8/view'><u>conditions générales</u></a> et certifie avoir 14 ans minimum. Remboursement sur simple demande dans un délai de 14 jours.
      %div{style: 'position: relative; display: inline-block'}
        = submit_tag 'Régler mes 35€', class: 'crazy-btn yellow'
        .shadow

      %a.link-center{ href: 'https://paypal.me/bloomr/35' } Je préfère payer avec Paypal

= javascript_include_tag 'https://js.stripe.com/v2/'

:javascript
  $(function(){
    Stripe.setPublishableKey("#{ ENV['STRIPE_PUBLISHABLE_KEY'] }");
  });

:javascript
  jQuery(function ($) {
    $('input.cc-number').payment('formatCardNumber');
    $('input.cc-exp').payment('formatCardExpiry');
    $('input.cc-cvc').payment('formatCardCVC');
  })


:javascript
  jQuery(function ($) {
  var show_error, stripeResponseHandler;

  var errorMessages = {
    incorrect_number: "Le numéro de carte est incorrect.",
    invalid_number: "Le numéro de carte n'est pas valide.",
    invalid_expiry_month: "Le mois d'expiration n'est pas valide.",
    invalid_expiry_year: "L'année d'expiration n'est pas valide.",
    invalid_cvc: "Le code de sécurité n'est pas valide.",
    expired_card: "La carte a expiré.",
    incorrect_cvc: "Le code de sécurité de la carte est incorrect.",
    card_declined: "Carte rejetée.",
    processing_error: "Une erreur est survenue.",
    empty_mail: "Veuillez saisir votre adresse mail"
  };

  $("#new_payment").submit(function (event) {
    var $form = $(this);

    if($('#email').val() === '') {
      show_error('empty_mail')
      return false;
    }

    $form.find("input[type=submit]").prop("disabled", true);
    Stripe.card.createToken($form, stripeResponseHandler);
    return false;
  });

  stripeResponseHandler = function (status, response) {
    var $form, token;
    $form = $("#new_payment");
    if (response.error) {
      show_error(response.error.code);
      $form.find("input[type=submit]").prop("disabled", false);
    } else {
      token = response.id;
      $form.append($("<input type=\"hidden\" name=\"stripeToken\" />").val(token));
      $form.get(0).submit();
    }
    return false;
    };

  show_error = function (code) {
    $("#flash-messages").html('<div class="alert alert-warning"><a class="close" data-dismiss="alert">×</a><div id="flash_alert">' + errorMessages[code] + '</div></div>');
    $('.alert').delay(5000).fadeOut(3000);
    return false;
    };
    });
