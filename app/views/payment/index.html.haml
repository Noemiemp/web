#payment
  .center
    %h1 Fabuleuse décision !

    %p Le paiement se fait par Carte Bancaire ou avec Paypal, mais avant...

    %p.first ...qui es tu, toi qui va suivre le parcours Bloomr ?
    = form_tag '/payment', :id => 'new_payment' do
      = text_field_tag :first_name, nil, placeholder: 'Ton prénom', required: true, class: 'blue'
      = email_field_tag :email, nil, placeholder: 'Ton adresse email', required: true, class: 'blue', 'data-stripe' => 'name'
      = text_field_tag :age, nil, placeholder: 'Ton age', required: true, class: 'blue'

      %div{style: 'position: relative; display: inline-block'}
      %p#flash-messages
      <p><span class= 'glyphicon glyphicon-lock'></span> Informations de paiement</p>
      = text_field_tag nil, nil, placeholder: 'Numéro de carte', required: true, class: 'large-cb', 'data-stripe' => 'number'
      %div.form-inline
        = text_field_tag nil, nil, placeholder: 'MM', required: true, class: 'small-cb', maxlength: 2, 'data-stripe' => 'exp-month'
        = text_field_tag nil, nil, placeholder: 'YYYY', required: true, class: 'small-cb', maxlength: 4, 'data-stripe' => 'exp-year'
        = text_field_tag nil, nil, placeholder: 'CVC', required: true, class: 'small-cb', maxlength: 4, 'data-stripe' => 'cvc'
      %div{style: 'position: relative; display: inline-block'}
      = submit_tag 'Go, je paye 15€ !', class: 'crazy-btn yellow'

      %a.bloomiser{ href: 'paypal.me/bloomr/15' } Je préfère payer avec Paypal

      %a.galerie{ href: '/portraits' }
        %ul
          %li.sprite.dev-card
          %li.sprite.parole-card
          %li.sprite.radis-card

= javascript_include_tag 'https://js.stripe.com/v2/'

:javascript
  $(function(){
   Stripe.setPublishableKey('pk_test_KFGPFZWb7lEmmfamW83Qsziy');
   //Stripe.setPublishableKey('<%= Rails.configuration.stripe[:publishable_key] %>');
  });

:javascript
  jQuery(function ($) {
  var show_error, stripeResponseHandler;

  var errorMessages = {
    incorrect_number: "Le numéro de carte est incorrect.",
    invalid_number: "Le numéro de carte n'est pas valide.",
    invalid_expiry_month: "Le mois d'expiration n'est pas valide.",
    invalid_expiry_year: "L'année d'expiration n'est pas valide.",
    invalid_cvc: "Le code de sécurité n'est pas valide.",
    expired_card: "La carte a expiré.",
    incorrect_cvc: "Le code de sécurité de la carte est incorrect.",
    card_declined: "Carte rejetée.",
    processing_error: "Une erreur est survenue.",
  };

  $("#new_payment").submit(function (event) {
    var $form;
    $form = $(this);
    $form.find("input[type=submit]").prop("disabled", true);
    Stripe.card.createToken($form, stripeResponseHandler);
    return false;
  });

  stripeResponseHandler = function (status, response) {
    var $form, token;
    $form = $("#new_payment");
    if (response.error) {
      show_error(response.error.code);
      $form.find("input[type=submit]").prop("disabled", false);
    } else {
      token = response.id;
      $form.append($("<input type=\"hidden\" name=\"stripeToken\" />").val(token));
      $form.get(0).submit();
    }
    return false;
    };

  show_error = function (code) {
    $("#flash-messages").html('<div class="alert alert-warning"><a class="close" data-dismiss="alert">×</a><div id="flash_alert">' + errorMessages[code] + '</div></div>');
    $('.alert').delay(5000).fadeOut(3000);
    return false;
    };
    });
